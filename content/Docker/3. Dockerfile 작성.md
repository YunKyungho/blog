
## 참조 공식 문서

- [Dockerfile Reference](https://docs.docker.com/reference/dockerfile/)
- [Best Practices](https://docs.docker.com/build/building/best-practices/)
- [Multi-stage builds](https://docs.docker.com/build/building/multi-stage/)
- [Build with Docker](https://docs.docker.com/build/)

---
## 기본 Dockerfile 예제

```dockerfile
# 베이스 이미지 지정
FROM python:3.11-slim

# 메타데이터 추가
LABEL maintainer="your-email@example.com"
LABEL description="My Python Application"

# 작업 디렉토리 설정
WORKDIR /app

# 환경 변수 설정
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# 시스템 패키지 업데이트 및 설치
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# 의존성 파일 복사 및 설치
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 애플리케이션 파일 복사
COPY . .

# 포트 노출
EXPOSE 8000

# 실행할 사용자 지정 (보안)
RUN useradd -m appuser
USER appuser

# 컨테이너 시작 시 실행할 명령
CMD ["python", "app.py"]
```

---
## 주요 Dockerfile 명령어 옵션 표

|명령어|설명|사용 예제|중요도|
|---|---|---|---|
|**FROM**|베이스 이미지 지정 (필수)|`FROM python:3.11-slim`|필수|
|**WORKDIR**|작업 디렉토리 설정|`WORKDIR /app`|필수|
|**COPY**|호스트에서 컨테이너로 파일 복사|`COPY . /app`|필수|
|**RUN**|이미지 빌드 시 명령 실행|`RUN pip install -r requirements.txt`|필수|
|**CMD**|컨테이너 시작 시 실행할 기본 명령|`CMD ["python", "app.py"]`|필수|
|**EXPOSE**|컨테이너가 리스닝할 포트 문서화|`EXPOSE 8000`|권장|
|**ENV**|환경 변수 설정|`ENV NODE_ENV=production`|권장|
|**ARG**|빌드 타임 변수 정의|`ARG VERSION=1.0`|선택|
|**LABEL**|메타데이터 추가|`LABEL version="1.0"`|선택|
|**ENTRYPOINT**|컨테이너 실행 파일 설정|`ENTRYPOINT ["python"]`|선택|
|**VOLUME**|마운트 포인트 생성|`VOLUME ["/data"]`|선택|
|**USER**|실행 사용자 지정|`USER appuser`|권장|
|**HEALTHCHECK**|컨테이너 헬스체크 설정|`HEALTHCHECK CMD curl -f http://localhost/`|선택|
|**SHELL**|기본 셸 변경|`SHELL ["/bin/bash", "-c"]`|선택|
|**ONBUILD**|자식 이미지에서 실행될 트리거|`ONBUILD COPY . /app`|고급|
|**STOPSIGNAL**|컨테이너 종료 시그널 설정|`STOPSIGNAL SIGTERM`|고급|
|**ADD**|COPY + URL 다운로드 + 압축 해제|`ADD archive.tar.gz /app`|선택|

## 알아두면 좋은 베스트 프랙티스

### 1. **멀티 스테이지 빌드**

````dockerfile
# 빌드 스테이지
FROM node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 프로덕션 스테이지
FROM node:18-slim
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY package*.json ./
RUN npm install --production
CMD ["node", "dist/index.js"]
```

### 2. **.dockerignore 파일 사용**
```
node_modules
.git
.env
*.md
.dockerignore
Dockerfile
````

### 3. **레이어 캐싱 최적화**

- 자주 변경되지 않는 명령을 먼저 배치
- `COPY`는 필요한 파일만 개별적으로

### 4. **보안 고려사항**

- `USER`로 non-root 사용자 실행
- 불필요한 패키지 설치 지양
- 최신 베이스 이미지 사용

## CMD vs ENTRYPOINT 차이

| 구분   | CMD                         | ENTRYPOINT               |
| ---- | --------------------------- | ------------------------ |
| 용도   | 기본 명령어                      | 컨테이너 실행 파일               |
| 덮어쓰기 | `docker run` 인자로 쉽게 덮어쓰기 가능 | `--entrypoint`로만 덮어쓰기 가능 |
| 조합   | ENTRYPOINT와 함께 사용 시 파라미터 역할 | CMD를 파라미터로 받음            |

dockerfile

```dockerfile
# CMD만 사용
CMD ["python", "app.py"]

# ENTRYPOINT만 사용
ENTRYPOINT ["python", "app.py"]

# 조합 사용 (권장)
ENTRYPOINT ["python"]
CMD ["app.py"]
```
